{% extends "report_base.html" %}

{% block content %}

<div class="card">
  <h2>Décision qualité globale</h2>
  <p>
    <strong>Score global :</strong> {{ global_score }} /
    <strong>Statut :</strong>
    {% if global_status == 'OK' %}
      <span class="pill ok">OK</span>
    {% elif global_status == 'À risque' %}
      <span class="pill risk">À risque</span>
    {% else %}
      <span class="pill ko">{{ global_status }}</span>
    {% endif %}
  </p>

  {% if suggestions_label %}
    <p class="muted small">
      <strong>Mode suggestions :</strong> <span class="pill info">{{ suggestions_label }}</span>
      {% if ai_enabled is defined %}
        {% if ai_enabled %}
          <span class="muted">— IA activée</span>
        {% else %}
          <span class="muted">— IA désactivée</span>
        {% endif %}
      {% endif %}
    </p>
  {% endif %}
</div>

<h2>Vue synthèse</h2>

<table>
  <thead>
    <tr>
      <th class="col-id">ID</th>
      <th class="col-score">Score</th>
      <th>Statut</th>
      <th class="col-center">Issues</th>
      <th class="col-center">Suggestions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in requirements %}
    <tr>
      <td class="col-id mono">{{ r.id }}</td>
      <td class="col-score"><strong>{{ r.score }}</strong></td>
      <td>
        {% if r.display_status == 'OK' %}
          <span class="pill ok">OK</span>
        {% elif r.display_status == 'À risque' %}
          <span class="pill risk">À risque</span>
        {% else %}
          <span class="pill ko">{{ r.display_status }}</span>
        {% endif %}
      </td>
      <td class="col-center">{{ r.issues|length }}</td>
      <td class="col-center">
        {% if r.ai_suggestions %}
          <span class="pill info">{{ suggestions_label }}</span>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Détails par exigence</h2>

{% for r in requirements %}
<details>
  <summary><span class="mono">{{ r.id }}</span> — Score <strong>{{ r.score }}</strong> — {{ r.display_status }}</summary>

  <p><strong>Texte exigence :</strong></p>
  <p>{{ r.text }}</p>

  <p><strong>Issues détectées :</strong></p>
  {% if r.issues %}
    <ul>
      {% for issue in r.issues %}
        <li>
          <span class="pill {% if issue.severity in ['CRITICAL'] %}ko{% elif issue.severity in ['MAJOR','MINOR'] %}risk{% else %}info{% endif %}">
            {{ issue.severity }}
          </span>
          <span class="muted">—</span>
          {{ issue.message }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Aucune issue détectée.</p>
  {% endif %}

  {% if r.ai_suggestions %}
    <p><strong>Suggestions {{ suggestions_label }} :</strong> <span class="pill info">{{ suggestions_label }}</span></p>
    <ul>
      {% for s in r.ai_suggestions %}
        <li>{{ s }}</li>
      {% endfor %}
    </ul>
  {% endif %}
</details>
{% endfor %}

{% endblock %}
